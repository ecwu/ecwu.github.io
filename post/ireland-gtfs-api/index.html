<!DOCTYPE html><html lang="en">
    <head>

<link rel="icon" type="image/x-icon" href="https://ecwuuuuu.com/favicon.ico">




<link rel="stylesheet" href="https://ecwuuuuu.com/css/style.min.a950ada5b7ec68b7d5301d7fe876fca96b26b23bc3a3c2705262f7c1cac54656.css" integrity="sha256-qVCtpbfsaLfVMB1/6Hb8qWsmsjvDo8JwUmL3wcrFRlY=">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>探索爱尔兰巴士实时交通数据 -  ECWU&#39;s Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Homepage and blog for Zhenghao Wu (ECWU), sharing thoughts on technology, everyday experiences, and photography. Engaging with the community through knowledge sharing.">
<meta name="keywords" content="GTFS,Transportation,Ireland,Smart Cities,Public Transport">
<meta name="author" content="ECWUUUUU"><script>
  
  (function() {
    const theme = localStorage.getItem("current-theme");
    
    if (theme === null) {
      
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        localStorage.setItem("current-theme", "dark");
        document.documentElement.classList.add('dark');
      } else {
        localStorage.setItem("current-theme", "light");
        document.documentElement.classList.remove('dark');
      }
    } else if (theme === 'dark') {
      
      document.documentElement.classList.add('dark');
    } else {
      
      document.documentElement.classList.remove('dark');
    }
  })();

  
  
  window.updateMermaidTheme = () => {
    if (typeof mermaid !== 'undefined') {
      const isDark = document.documentElement.classList.contains("dark");

      const mermaids = document.querySelectorAll('pre.mermaid');
      mermaids.forEach(e => {
        if (e.getAttribute('data-processed')) {
          
          e.removeAttribute('data-processed');
          
          e.innerHTML = e.getAttribute('data-graph');
        } else {
          
          e.setAttribute('data-graph', e.textContent);
        }
      });

      if (isDark) {
        initMermaidDark();
        mermaid.run();
      } else {
        initMermaidLight();
        mermaid.run();
      }
    }
  }

  function change_color_mode(){
    if (localStorage.getItem('current-theme') === 'light') {
      document.documentElement.classList.add('dark')
      localStorage.setItem('current-theme', 'dark');
      change_discussion_color_mode();
      updateMermaidTheme();
    } else {
      document.documentElement.classList.remove('dark')
      localStorage.setItem('current-theme', 'light');
      change_discussion_color_mode();
      updateMermaidTheme();
    }
  }
  

  function change_discussion_color_mode(){
    
    const theme = localStorage.getItem('current-theme') === 'light' ? 'light' : 'dark'
    const message = {
      setConfig: {
        theme: theme,
      }
    };
    
    const iframe = document.querySelector('iframe.giscus-frame');
    if (iframe) {
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
    }
    
  }

  
  

  document.addEventListener("DOMContentLoaded", () => {
    

    document
      .getElementById("header-theme-button")
      .addEventListener("click", change_color_mode);
  });

</script>

</head>
    <body class="transition-colors duration-300"><div class="pt-6">
    
    <div class="nav-title flex flex-row flex-wrap gap-2"><a href="https://ecwuuuuu.com/">
    
    <svg class="w-36 fill-gray-900 dark:fill-gray-200" fill="currentColor" viewBox="0 0 204.24 43.44" xmlns="http://www.w3.org/2000/svg">
        <path d="M0,43.08V0.36h18.24v5.76H6.12v12.54h10.56v5.76H6.12v12.54h12.12v6.12H0z"/>
        <path d="M41.64,30.9v2.64c0,1.32-0.25,2.57-0.75,3.75c-0.5,1.18-1.19,2.23-2.07,3.15c-0.88,0.92-1.91,1.65-3.09,2.19  c-1.18,0.54-2.45,0.81-3.81,0.81c-1.16,0-2.34-0.16-3.54-0.48c-1.2-0.32-2.28-0.88-3.24-1.68s-1.75-1.83-2.37-3.09  c-0.62-1.26-0.93-2.87-0.93-4.83V9.84c0-1.4,0.24-2.7,0.72-3.9c0.48-1.2,1.16-2.24,2.04-3.12c0.88-0.88,1.93-1.57,3.15-2.07  C28.97,0.25,30.32,0,31.8,0c2.88,0,5.22,0.94,7.02,2.82c0.88,0.92,1.57,2.01,2.07,3.27c0.5,1.26,0.75,2.63,0.75,4.11v2.4h-6.12  v-2.04c0-1.2-0.34-2.24-1.02-3.12c-0.68-0.88-1.6-1.32-2.76-1.32c-1.52,0-2.53,0.47-3.03,1.41c-0.5,0.94-0.75,2.13-0.75,3.57v21.84  c0,1.24,0.27,2.28,0.81,3.12s1.51,1.26,2.91,1.26c0.4,0,0.83-0.07,1.29-0.21c0.46-0.14,0.89-0.37,1.29-0.69  c0.36-0.32,0.66-0.76,0.9-1.32c0.24-0.56,0.36-1.26,0.36-2.1v-2.1H41.64z"/>
        <path d="M78.36,0.36L72,43.08h-5.76l-4.68-27.72h-0.12l-4.62,27.72h-5.76L44.7,0.36h6.48l3.06,27.12h0.12l4.8-27.12h4.68l4.98,27.78  h0.12l2.94-27.78H78.36z"/>
        <path d="M102,0.36v33.12c0,1.4-0.25,2.69-0.75,3.87c-0.5,1.18-1.21,2.23-2.13,3.15c-0.92,0.92-1.98,1.64-3.18,2.16  c-1.2,0.52-2.48,0.78-3.84,0.78c-1.36,0-2.63-0.26-3.81-0.78c-1.18-0.52-2.23-1.24-3.15-2.16c-0.92-0.92-1.64-1.97-2.16-3.15  c-0.52-1.18-0.78-2.47-0.78-3.87V0.36h6.12v32.52c0,1.52,0.36,2.64,1.08,3.36c0.72,0.72,1.62,1.08,2.7,1.08  c1.08,0,1.98-0.36,2.7-1.08c0.72-0.72,1.08-1.84,1.08-3.36V0.36H102z"/>
        <path d="M127.56,0.36v33.12c0,1.4-0.25,2.69-0.75,3.87c-0.5,1.18-1.21,2.23-2.13,3.15c-0.92,0.92-1.98,1.64-3.18,2.16  s-2.48,0.78-3.84,0.78s-2.63-0.26-3.81-0.78c-1.18-0.52-2.23-1.24-3.15-2.16c-0.92-0.92-1.64-1.97-2.16-3.15  c-0.52-1.18-0.78-2.47-0.78-3.87V0.36h6.12v32.52c0,1.52,0.36,2.64,1.08,3.36c0.72,0.72,1.62,1.08,2.7,1.08  c1.08,0,1.98-0.36,2.7-1.08c0.72-0.72,1.08-1.84,1.08-3.36V0.36H127.56z"/>
        <path d="M153.12,0.36v33.12c0,1.4-0.25,2.69-0.75,3.87c-0.5,1.18-1.21,2.23-2.13,3.15c-0.92,0.92-1.98,1.64-3.18,2.16  c-1.2,0.52-2.48,0.78-3.84,0.78s-2.63-0.26-3.81-0.78c-1.18-0.52-2.23-1.24-3.15-2.16c-0.92-0.92-1.64-1.97-2.16-3.15  c-0.52-1.18-0.78-2.47-0.78-3.87V0.36h6.12v32.52c0,1.52,0.36,2.64,1.08,3.36c0.72,0.72,1.62,1.08,2.7,1.08s1.98-0.36,2.7-1.08  c0.72-0.72,1.08-1.84,1.08-3.36V0.36H153.12z"/>
        <path d="M178.68,0.36v33.12c0,1.4-0.25,2.69-0.75,3.87c-0.5,1.18-1.21,2.23-2.13,3.15c-0.92,0.92-1.98,1.64-3.18,2.16  c-1.2,0.52-2.48,0.78-3.84,0.78c-1.36,0-2.63-0.26-3.81-0.78c-1.18-0.52-2.23-1.24-3.15-2.16c-0.92-0.92-1.64-1.97-2.16-3.15  c-0.52-1.18-0.78-2.47-0.78-3.87V0.36H165v32.52c0,1.52,0.36,2.64,1.08,3.36c0.72,0.72,1.62,1.08,2.7,1.08  c1.08,0,1.98-0.36,2.7-1.08c0.72-0.72,1.08-1.84,1.08-3.36V0.36H178.68z"/>
        <path d="M204.24,0.36v33.12c0,1.4-0.25,2.69-0.75,3.87c-0.5,1.18-1.21,2.23-2.13,3.15c-0.92,0.92-1.98,1.64-3.18,2.16  c-1.2,0.52-2.48,0.78-3.84,0.78s-2.63-0.26-3.81-0.78c-1.18-0.52-2.23-1.24-3.15-2.16c-0.92-0.92-1.64-1.97-2.16-3.15  c-0.52-1.18-0.78-2.47-0.78-3.87V0.36h6.12v32.52c0,1.52,0.36,2.64,1.08,3.36c0.72,0.72,1.62,1.08,2.7,1.08s1.98-0.36,2.7-1.08  c0.72-0.72,1.08-1.84,1.08-3.36V0.36H204.24z"/>
    </svg>
    <p class="sr-only">ECWU Homepage</p>
    
</a></div>
    
<nav aria-label="navbar" class="mb-3 mr-8">
    <ol role="list" class="flex flex-wrap">
        
        
        
        <li>
        <div class="flex items-center justify-center">
            <a href="https://ecwuuuuu.com/" class='mr-2 font-medium text-gray-900 dark:text-gray-200 visited:text-gray-900 dark:visited:text-gray-200'>Home</a>
            
            <svg width="16" height="20" viewBox="0 0 16 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true" class="mr-2 w-4 h-5 fill-gray-300">
                <path d="M5.697 4.34L8.98 16.532h1.327L7.025 4.341H5.697z" />
            </svg>
            
        </div>
        </li>
        
        <li>
        <div class="flex items-center justify-center">
            <a href="https://ecwuuuuu.com/post/" class='mr-2 font-medium text-gray-900 dark:text-gray-200 visited:text-gray-900 dark:visited:text-gray-200'>Posts</a>
            
            <svg width="16" height="20" viewBox="0 0 16 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true" class="mr-2 w-4 h-5 fill-gray-300">
                <path d="M5.697 4.34L8.98 16.532h1.327L7.025 4.341H5.697z" />
            </svg>
            
        </div>
        </li>
        
        <li>
        <div class="flex items-center justify-center">
            <a href="https://ecwuuuuu.com/photography/" class='mr-2 font-medium text-gray-900 dark:text-gray-200 visited:text-gray-900 dark:visited:text-gray-200'>Photos</a>
            
            <svg width="16" height="20" viewBox="0 0 16 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true" class="mr-2 w-4 h-5 fill-gray-300">
                <path d="M5.697 4.34L8.98 16.532h1.327L7.025 4.341H5.697z" />
            </svg>
            
        </div>
        </li>
        
        <li>
        <div class="flex items-center justify-center">
            <a href="https://ecwuuuuu.com/series/" class='mr-2 font-medium text-gray-900 dark:text-gray-200 visited:text-gray-900 dark:visited:text-gray-200'>Series</a>
            
            <svg width="16" height="20" viewBox="0 0 16 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true" class="mr-2 w-4 h-5 fill-gray-300">
                <path d="M5.697 4.34L8.98 16.532h1.327L7.025 4.341H5.697z" />
            </svg>
            
        </div>
        </li>
        
        <li>
        <div class="flex items-center justify-center">
            <a href="https://ecwuuuuu.com/page/about/" class='mr-2 font-medium text-gray-900 dark:text-gray-200 visited:text-gray-900 dark:visited:text-gray-200'>About</a>
            
            <svg width="16" height="20" viewBox="0 0 16 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true" class="mr-2 w-4 h-5 fill-gray-300">
                <path d="M5.697 4.34L8.98 16.532h1.327L7.025 4.341H5.697z" />
            </svg>
            
        </div>
        </li>
        
        <li>
        <div class="flex items-center justify-center">
            <a href="https://ecwuuuuu.com/page/friends/" class='mr-2 font-medium text-gray-900 dark:text-gray-200 visited:text-gray-900 dark:visited:text-gray-200'>Friends</a>
            
            
        </div>
        </li>
        
    </ol>
</nav><div  class="flex items-center space-x-2">
    <div class="w-6 h-6 inline-flex items-center justify-center rounded-lg bg-white dark:bg-black shadow-inner ring-1 ring-black/5">
        <i id="header-theme-button" data-feather="sun" class="site-header-navlink rounded cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 hidden dark:block fill-gray-900 dark:fill-gray-200" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                    d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                    clip-rule="evenodd" />
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 block dark:hidden fill-gray-900 dark:fill-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
              </svg>
        </i>
    </div>
    <span class="dark:hidden text-sm">To Dark Mode</span>
    <span class="hidden dark:block dark:text-gray-200 text-sm">To Light Mode</span>
</div></div><div class="mb-12 mt-16 w-content">
  <h1 class="text-gray-900 dark:text-gray-200">探索爱尔兰巴士实时交通数据</h1>
  <h2 class="text-gray-700 dark:text-gray-400">了解 GTFS 交通数据并制作一个 Telegram 机器人</h2>

  
  <div class="text-gray-700 dark:text-gray-400">
    <span>
      
      <p><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg> Zhenghao Wu</p>
      


      

      
      <p>
        
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
        </svg>
        Status: Finished
        
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
        </svg>
        Confidence: likely
        
        
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z" />
        </svg>
        Importance: 6
        
        
      </p>
      
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
        </svg> <a href="#article-info-card">Post Details</a>
      </p>
      
      
    </span>
  </div>
  
</div><main>
<article class="prose dark:prose-invert lg:prose-xl md:prose-lg prose-ul:leading-5 prose-ol:leading-5">
    
    <p>直到最近才发现<a href="https://www.nationaltransport.ie">爱尔兰交通管理局</a>有一个公开的交通数据。之前我是在使用 <a href="https://transitapp.com/">Transit App</a> 来查询时刻表和车辆位置（也是才知道 TFI Live 也可以看到很详细的数据），但有时候这些应用并不能完全满足我的需求（可能只是我个人想要更多的数据，但它们本身是相当不错的软件）。</p>
<p>所以这篇文章主要是记录探索这个 API 的过程，并介绍我是如何将它变成一个用于跟踪我常用路线的 Telegram 机器人的。</p>
<h2 id="tfi-提供了什么">TFI 提供了什么</h2>
<p>数据它主要包括两个部分：GTFS 数据源和两个实时信息的 API。GTFS 数据源包含提前定义好的线路、站点和时刻表的静态信息，而 API 则提供实时车辆位置和线路到站时间的状态更新。</p>
<p>GTFS 的全称是 General Transit Feed Specification（通用交通数据规范），最初由 <a href="https://developers.google.com/transit/gtfs-realtime">Google</a> 开发，用于共享公共交通数据。后来它发展成为一个<a href="https://gtfs.org/documentation/overview/">开放标准</a>，全球许多交通机构都在使用。</p>
<p>严格说，提前定义好的静态数据属于 GTFS 的部分，而 API 获取的数据则属于 GTFS Realtime 的范畴。静态的 GTFS 数据可以从 <a href="https://www.transportforireland.ie/transitData/PT_Data.html">Transport for Ireland 网站</a>下载，格式为 zip 文件。静态文件的更新频率不固定，建议定期获取最新的数据，以保证路线和时刻表的准确性。</p>
<h2 id="相关项目">相关项目</h2>
<p>我首先查找了一些已经利用该 API 的现有项目。其实 GTFS 相关的项目有很多，我这边只列举专注于爱尔兰/英国交通数据的几个：</p>
<ol>
<li><a href="https://github.com/seanrees/gtfs-upcoming">seanrees/gtfs-upcoming</a>: 作为 GTFS-R 客户端获取数据，将数据转换为一个易用的 API，可以直接站点编号查看即将到站的车辆信息。</li>
<li><a href="https://github.com/seanblanchfield/tfi-gtfs">seanblanchfield/tfi-gtfs</a>: 功能与 <a href="https://github.com/seanrees/gtfs-upcoming">seanrees/gtfs-upcoming</a> 类似，优化了内存占用，实现了容器化和 Redis 缓存。</li>
<li><a href="https://github.com/jclgoodwin/bustimes.org">jclgoodwin/bustimes.org</a>: 一个相当庞大的开源项目，旨在提供实时公交信息，支持多种数据源。</li>
</ol>
<p>我最开始是基于 tfi-gtfs 来做的，想在这个基础上加入路线信息，行程信息的接口。但因为原应用呈现为一个 API，所以引入的 Flask 框架和节省内存的设计让在基础上开发变得困难。所以我在通过它了解了 GTFS 的基本结构和数据模型后，决定从头开始构建一个新的解决方案。</p>
<h2 id="gtfs-数据模型">GTFS 数据模型</h2>
<p>



<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/GTFS_class_diagram.svg/1920px-GTFS_class_diagram.svg.png" 
     alt="Class diagram of GTFS" 
     
     >
</p>
<p>如图是 GTFS 数据模型的类图，但并不是每一个类都需要关注，以下是（我的应用中）最重要的几个类：</p>
<ol>
<li><strong>线路（Routes）</strong>：定义了公交线路的基本信息，包括线路编号、名称、起点和终点等。</li>
<li><strong>站点（Stops）</strong>：描述了公交站点的位置信息，包括站点编号、名称、经纬度等。</li>
<li><strong>旅程（Trips）</strong>：表示一次完整的公交行程，包括所经过的线路、站点和时间信息。</li>
<li><strong>站点时间（Stop Times）</strong>：提供了一个旅程中每个站点的到达和离开时间信息。</li>
<li><strong>形状（Shapes）</strong>：描述了公交线路的空间形状，由一序列经纬度信息组成。</li>
</ol>
<p>GTFS-R 数据中的两个都很重要：</p>
<ol>
<li><strong>实时车辆位置（Vehicle）</strong>：提供了每辆公交车的当前位置，和实时位置上报的时间。</li>
<li><strong>预计到站时间（Trip Updates）</strong>：提供了每个旅程的最新状态，包括预计到达时间、延误信息等，可以用于实时更新公交时刻表。</li>
</ol>
<p>如果是符合标准的 GTFS 数据，可以使用 <a href="https://github.com/MobilityData/gtfs-realtime-bindings">gtfs-realtime-bindings</a> 来处理。它会根据 protobuf 定义生成相应的 Python 类，简化数据的解析和使用。</p>
<h2 id="客户端架构和设计">客户端架构和设计</h2>
<p>因为我只需要提供实时的公交信息，那么我归纳了以下几个主要功能：</p>
<ul>
<li>作为 GTFS/GTFS-R 的客户端，下载静态数据存储到本地，以及定期获取实时数据。</li>
<li>针对一个站点，获得该站点的实时到站信息，尽量与 TFI Live 的数据保持一致。</li>
<li>针对一个线路，获得该线路中当前时间附近所有旅程的状态（已完成，运行中，计划中）</li>
<li>针对一个旅程，获得该旅程的实时状态更新，包括车辆位置和预计到达时间以及接下来的站点信息。</li>
</ul>
<p>数据量方面（截止 2025 年 8 月 23 日）：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">类名</th>
          <th style="text-align: left">数据量</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Routes</td>
          <td style="text-align: left">433</td>
          <td style="text-align: left">线路</td>
      </tr>
      <tr>
          <td style="text-align: left">Stops</td>
          <td style="text-align: left">10456</td>
          <td style="text-align: left">站点</td>
      </tr>
      <tr>
          <td style="text-align: left">Trips</td>
          <td style="text-align: left">408525</td>
          <td style="text-align: left">行程（数十万条）</td>
      </tr>
      <tr>
          <td style="text-align: left">Stop Times</td>
          <td style="text-align: left">11306094</td>
          <td style="text-align: left">站点到达时间（数千万条）</td>
      </tr>
      <tr>
          <td style="text-align: left">Shapes</td>
          <td style="text-align: left">6937648</td>
          <td style="text-align: left">形状（数百万条）</td>
      </tr>
      <tr>
          <td style="text-align: left">Vehicle</td>
          <td style="text-align: left">100～2000</td>
          <td style="text-align: left">车辆（随时间从数百条到两千多条）</td>
      </tr>
      <tr>
          <td style="text-align: left">Trip Updates</td>
          <td style="text-align: left">10000+</td>
          <td style="text-align: left">旅程更新（数万条）</td>
      </tr>
  </tbody>
</table>
<p>静态数据文件是 txt 格式的，里面内容是 CSV 格式的。我选择 SQLite 作为数据库，直接通过 pandas 的 <code>to_sql</code> 方法将数据写入数据库中。为了提高查询效率，我为常用的字段添加了索引。</p>
<p>机器人方面，我使用了 <a href="https://github.com/python-telegram-bot/python-telegram-bot">python-telegram-bot</a> 库来实现与 Telegram 的交互。通过设置 Webhook，我可以接收用户的消息并进行处理。机器人主要提供以下功能：</p>
<h2 id="arrival实时站牌的实现">Arrival（实时站牌）的实现</h2>
<p>


  


<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Sign-1040274%2C_Leixlip%2C_Co._Kildare%2C_Ireland.jpg/960px-Sign-1040274%2C_Leixlip%2C_Co._Kildare%2C_Ireland.jpg" 
     alt="爱尔兰的电子倒计时站牌" 
     class="no-dark-invert"
     >

爱尔兰的电子倒计时站牌 CC BY-SA 4.0 Author: <a href="https://commons.wikimedia.org/wiki/User:Leimanbhradain">Leimanbhradain</a></p>
<p>这个功能想实现如图所示的电子倒计时站牌。因为并不是所有的站点都有电子的倒计时牌。这个站牌会显示三到四个即将到站的公交车信息，并显示预计到达时间。</p>
<p>下面以我常坐的站点为例，来解释算法的处理逻辑，并用于验证效果。分别是站点 UCD Belfield 768 和 Fitzwilliam Street 750。</p>
<ol>
<li>处理站点第一步是获取站点的 ID (stop_id)。站名和数字的编号并不是 stop 表的主键，我们先需要通过静态数据中的 Stops 表来获取。</li>
</ol>
<ul>
<li>UCD Belfield 768 是 <code>8250DB000768</code></li>
<li>Fitzwilliam Street 750 是 <code>8220DB000750</code></li>
</ul>
<ol start="2">
<li>获取到了 stop_id 后，我们首先需要获取计划的旅程，这需要联表查询。涉及 routes，trips，stop_times 三个表 （routes.stop_id -&gt; trips.route_id，trips.trip_id -&gt; stop_times.trip_id）。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>    st.trip_id, st.arrival_time, st.stop_sequence, 
</span></span><span style="display:flex;"><span>    t.service_id, t.trip_headsign, t.direction_id, 
</span></span><span style="display:flex;"><span>    r.route_short_name, r.route_long_name, r.agency_id
</span></span><span style="display:flex;"><span><span style="color:#719e07">FROM</span> stop_times st
</span></span><span style="display:flex;"><span><span style="color:#719e07">JOIN</span> trips t <span style="color:#719e07">ON</span> st.trip_id <span style="color:#719e07">=</span> t.trip_id
</span></span><span style="display:flex;"><span><span style="color:#719e07">JOIN</span> routes r <span style="color:#719e07">ON</span> t.route_id <span style="color:#719e07">=</span> r.route_id
</span></span><span style="display:flex;"><span><span style="color:#719e07">WHERE</span> st.stop_id <span style="color:#719e07">=</span> <span style="color:#719e07">?</span>
</span></span></code></pre></div><p>联表查询后，我们就可以获得当前站的详细行程信息，包括哪趟路线会<strong>计划</strong>何时在该站点停靠。</p>
<ol start="3">
<li>接下来我们需要按日期提取执行计划（比如周日时，有一些班次不运行），这需要从 calendar 和 calendar_dates 两个表中获取。calendar 定义了常规的服务日期，而 calendar_dates 则定义了例外日期（如节假日）。我们需要根据当前日期来过滤出有效的 service_id。</li>
</ol>
<p>Trips 表中包含 service_id 字段，那么前一步的查询结果中我们就可以进一步的过滤出有效的行程。</p>
<ol start="4">
<li>到现在其实我们已经可以通过 arrival_time 排序并通过展示大于当前时间的到达时间来实现电子倒计时站牌的功能。但是实时的数据目前还没有用上，我们需要结合 Trip Updates 数据来实现。</li>
</ol>
<p>先介绍一下 Trip Updates 关键的字段 (拆成两段)</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">trip_id</th>
          <th style="text-align: left">route_id</th>
          <th style="text-align: left">schedule_relationship</th>
          <th style="text-align: left">direction_id</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">104762_28</td>
          <td style="text-align: left">104762</td>
          <td style="text-align: left">SCHEDULED</td>
          <td style="text-align: left">0</td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th style="text-align: left">stop_id</th>
          <th style="text-align: left">stop_sequence</th>
          <th style="text-align: left">arrival_delay</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">15513</td>
          <td style="text-align: left">31</td>
          <td style="text-align: left">7098</td>
      </tr>
  </tbody>
</table>
<p>可以看到，里面包含了一个行程在某个站点的延误时间数据，那么根据上一部得到的计划到站时间加上 arrival_delay 就可以得到该旅途到站点的预计时间。</p>
<p>但里面其实有个坑：这个实时数据中并不是每个站点都有对应的到达延误信息的，我这边展示 trip_id <code>105097_325</code> 的查询结果：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">stop_id</th>
          <th style="text-align: left">stop_sequence</th>
          <th style="text-align: left">arrival_delay</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">3930</td>
          <td style="text-align: left">18</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">914</td>
          <td style="text-align: left">19</td>
          <td style="text-align: left">77</td>
      </tr>
      <tr>
          <td style="text-align: left">3615</td>
          <td style="text-align: left">23</td>
          <td style="text-align: left">42</td>
      </tr>
      <tr>
          <td style="text-align: left">818</td>
          <td style="text-align: left">25</td>
          <td style="text-align: left">77</td>
      </tr>
      <tr>
          <td style="text-align: left">814</td>
          <td style="text-align: left">29</td>
          <td style="text-align: left">105</td>
      </tr>
      <tr>
          <td style="text-align: left">3851</td>
          <td style="text-align: left">32</td>
          <td style="text-align: left">45</td>
      </tr>
      <tr>
          <td style="text-align: left">38990</td>
          <td style="text-align: left">36</td>
          <td style="text-align: left">76</td>
      </tr>
      <tr>
          <td style="text-align: left">1813</td>
          <td style="text-align: left">39</td>
          <td style="text-align: left">82</td>
      </tr>
      <tr>
          <td style="text-align: left">1722</td>
          <td style="text-align: left">41</td>
          <td style="text-align: left">13</td>
      </tr>
      <tr>
          <td style="text-align: left">1671</td>
          <td style="text-align: left">43</td>
          <td style="text-align: left">83</td>
      </tr>
      <tr>
          <td style="text-align: left">2017</td>
          <td style="text-align: left">46</td>
          <td style="text-align: left">7</td>
      </tr>
      <tr>
          <td style="text-align: left">38991</td>
          <td style="text-align: left">48</td>
          <td style="text-align: left">171</td>
      </tr>
  </tbody>
</table>
<p>可以看到里面 stop_sequence 是不连续的，这意味着并不是所有的站点都有实时的到达延误信息。针对这个情况，我采用了以下策略：</p>
<ol>
<li>优先使用实时数据中的到达延误信息，如果没有，则回退到计划的到达时间。</li>
<li>对于没有实时到达延误信息的站点，使用相邻站点的到达延误信息进行计算。</li>
</ol>
<p>完整的获得延误估算的伪代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>函数 获取最近的延误估算(trip_id, stop_sequence, 所有实时更新数据):
</span></span><span style="display:flex;"><span>  如果实时更新数据为空:
</span></span><span style="display:flex;"><span>    返回 None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  # 获取该行程所有有延误信息的更新
</span></span><span style="display:flex;"><span>  trip_updates = 过滤实时更新数据，条件为 trip_id 匹配且 arrival_delay 不为空
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  如果 trip_updates 为空:
</span></span><span style="display:flex;"><span>    返回 None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  # 按照 stop_sequence 排序
</span></span><span style="display:flex;"><span>  trip_updates = 按 stop_sequence 排序
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  # 查找是否有精确匹配的 stop_sequence
</span></span><span style="display:flex;"><span>  exact_match = 过滤 trip_updates，条件为 stop_sequence 等于目标 stop_sequence
</span></span><span style="display:flex;"><span>  如果 exact_match 不为空:
</span></span><span style="display:flex;"><span>    返回 exact_match 的第一个 arrival_delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  # 查找最近的前后站点
</span></span><span style="display:flex;"><span>  before_stops = 过滤 trip_updates，条件为 stop_sequence 小于目标 stop_sequence
</span></span><span style="display:flex;"><span>  after_stops = 过滤 trip_updates，条件为 stop_sequence 大于目标 stop_sequence
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  如果 before_stops 不为空:
</span></span><span style="display:flex;"><span>    # 使用最近的前一个站点的延误
</span></span><span style="display:flex;"><span>    返回 before_stops 的最后一个 arrival_delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  如果 after_stops 不为空:
</span></span><span style="display:flex;"><span>    # 使用最近的后一个站点的延误
</span></span><span style="display:flex;"><span>    返回 after_stops 的第一个 arrival_delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  返回 None
</span></span></code></pre></div><p>根据新的算法，结合实时数据，我们可以得到更准确的预计到达时间，从而提升电子倒计时站牌的准确性。在展示时，我们只需要再计算预计到达时间与当前时间的差值，即可实现倒计时功能。</p>
<h3 id="效果展示">效果展示</h3>
<ul>
<li>768 站在周日的预计到达时间，与 TFI Live 的数据对比：</li>
</ul>
<p>



<img src="https://cdn.ecwuuuuu.com/blog/image/tfi-test-768.jpg-compressed.webp" 
      
     
     >
</p>
<p>可以看到结果相当接近，（机场快线 700 不是同一个数据源，所以我的结果里没有）</p>

</article>
</main>
<div class="pb-10 w-content">
  <div class="bg-white dark:bg-gray-900 drop-shadow-lg overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-200">
        <a id="article-info-card"></a>
        Article Card
      </h3>
      <p class="mt-1 text-sm text-gray-500">
        For "<span class="italic">探索爱尔兰巴士实时交通数据</span>"
      </p>
    </div>
    <div class="border-t border-gray-200 dark:border-gray-700">
      <dl>
        <table class="border-collapse table-fixed w-full">
          <tbody class="bg-white dark:bg-gray-800">
            
            <tr class="px-4 py-5">
              <th
                class="text-left border-b border-gray-100 dark:border-gray-700 pl-6 dark:text-gray-500 w-1/3 px-4 py-5 text-sm font-medium text-gray-500">
                Author</td>
              <td
                class="border-b font-bold border-gray-100 dark:border-gray-700 p-4 pl-8 text-gray-500 dark:text-gray-400 mt-1 px-4 py-5 text-sm ">
                Zhenghao Wu</td>
            </tr>
            
            
            <tr class="px-4 py-5">
              <th
                class="text-left border-b border-gray-100 dark:border-gray-700 pl-6 dark:text-gray-500 w-1/3 px-4 py-5 text-sm font-medium text-gray-500">
                Publish & Update Date</td>
              <td
                class="font-bold border-b border-gray-100 dark:border-gray-700 p-4 pl-8 text-gray-500 dark:text-gray-400 mt-1 px-4 py-5 text-sm">
                2025-08-24</td>
            </tr>
            
            
            <tr class="px-4 py-5">
              <th
                class="text-left border-b border-gray-100 dark:border-gray-700 pl-6 dark:text-gray-500 w-1/3 px-4 py-5 text-sm font-medium text-gray-500">
                Tags</td>
              <td
                class="font-bold border-b border-gray-100 dark:border-gray-700 p-4 pl-8 text-gray-500 dark:text-gray-400 mt-1 px-4 py-5 text-sm">
                
                <a class="rounded inline-block mt-1 mb-1 py-1 px-2 text-xs font-medium text-white bg-gray-900 visited:text-white dark:visited:text-white"
                  href="https://ecwuuuuu.com/tags/gtfs">GTFS</a>
                
                <a class="rounded inline-block mt-1 mb-1 py-1 px-2 text-xs font-medium text-white bg-gray-900 visited:text-white dark:visited:text-white"
                  href="https://ecwuuuuu.com/tags/transportation">Transportation</a>
                
                <a class="rounded inline-block mt-1 mb-1 py-1 px-2 text-xs font-medium text-white bg-gray-900 visited:text-white dark:visited:text-white"
                  href="https://ecwuuuuu.com/tags/ireland">Ireland</a>
                
                <a class="rounded inline-block mt-1 mb-1 py-1 px-2 text-xs font-medium text-white bg-gray-900 visited:text-white dark:visited:text-white"
                  href="https://ecwuuuuu.com/tags/smart-cities">Smart Cities</a>
                
                <a class="rounded inline-block mt-1 mb-1 py-1 px-2 text-xs font-medium text-white bg-gray-900 visited:text-white dark:visited:text-white"
                  href="https://ecwuuuuu.com/tags/public-transport">Public Transport</a>
                
              </td>
            </tr>
            
            
            <tr class="px-4 py-5">
              <th
                class="text-left border-b border-gray-100 dark:border-gray-700 pl-6 dark:text-gray-500 w-1/3 px-4 py-5 text-sm font-medium text-gray-500">
                Extra Materials</td>
              <td
                class="font-bold border-b border-gray-100 dark:border-gray-700 p-4 pl-8 text-gray-500 dark:text-gray-400 mt-1 px-4 py-5 text-sm">
                <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                  <ul role="list"
                    class="border border-gray-200 dark:border-gray-700 rounded-md divide-y divide-gray-200 dark:divide-gray-700">
                    
                    <li class="pl-3 pr-4 py-3 flex items-center justify-between text-sm">
                      <div class="w-0 flex-1 flex items-center">
                        
                        
                        
                        <svg xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                          stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>

                        
                        
                        <span class="ml-2 flex-1 w-0 truncate text-gray-900 dark:text-gray-200">
                          GTFS Documentation
                        </span>
                      </div>
                      <div class="ml-4 flex-shrink-0">
                        <a href="https://developers.google.com/transit/gtfs" class="font-medium text-indigo-600 hover:text-indigo-500">
                          Check
                        </a>
                      </div>
                    </li>
                    
                  </ul>
                </dd>
              </td>
            </tr>
            
            
            
            
            
          </tbody>
        </table>
    </div>
  </div>
</div>


<div class="pb-10 w-content ">
  <script src="https://giscus.app/client.js"
          data-repo="ecwu/ecwu.github.io"
          data-repo-id="MDEwOlJlcG9zaXRvcnkxNjQzMzE1NjY="
          data-category="Blog Post Discussion"
          data-category-id="DIC_kwDOCcuALs4CObNl"
          data-mapping="pathname"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="botton"
          data-theme="preferred_color_scheme"
          data-lang="en"
          crossorigin="anonymous"
          async>
  </script>
</div>




<div>
  <footer class="relative mb-6 text-gray-900 dark:text-gray-200">
    <hr class="pb-5"><div class="flex justify-begin w-full mx-auto mb-2">
  <ul class="flex flex-row justify-begin text-lg space-x-2">
          

      
      <li>
          <a href="https://ecwuuuuu.com/index.xml" aria-label="RSS"
              class="round-button social-button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="w-5 h-5 fill-gray-700 hover:fill-gray-900 dark:fill-gray-400 dark:hover:fill-gray-200" viewBox="0 0 16 16">
                <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2zm0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2zm.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
              </svg>
          </a>
      </li>
      
  </ul>
</div><p>
      
      Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/ecwu/ecwu-theme">ecwu-theme</a>.
      Build by GitHub Actions at: 2025-10-23 22:36 CST.
    </p>
    <p>
      
      &copy;2025
      ECWUUUUU.
      All rights reserved.
      

    </p>
    
    <p>
      <a href="http://beian.miit.gov.cn/"> 粤 ICP 备 17015575 号 - 1</a>
    </p>
    
    <p class="text-sm my-4">
       Google Analytics enabled   | <a href="https://ecwuuuuu.com/page/changelog">site changelog</a>
    </p>
  </footer>
</div>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-HSPDSQWH5L"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-HSPDSQWH5L');
        }
      </script>


    </body>
</html>
